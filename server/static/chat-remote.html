<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekend Chart - AI Browser Control</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        body { overflow: hidden; }

        .chat-container {
            display: grid;
            grid-template-columns: 28% 72%;
            height: 100vh;
            max-width: 100%;
            padding: 0;
        }

        @media (max-width: 900px) {
            .chat-container {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr 1fr;
            }
        }

        /* Chat Panel */
        .chat-panel {
            display: flex;
            flex-direction: column;
            border-right: 1px solid #333;
            background: #1a1a2e;
            min-height: 0; /* Fix flex scroll issue */
            overflow: hidden;
        }

        .chat-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            border-bottom: 1px solid #333;
            background: #16213e;
        }

        .chat-header h1 {
            flex: 1;
            font-size: 16px;
            color: #e94560;
        }

        .chat-header .nav-btn {
            width: 36px;
            height: 36px;
            font-size: 16px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            min-height: 0; /* Fix flex scroll issue */
        }

        .message {
            margin-bottom: 16px;
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 85%;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .message.user {
            background: #3b82f6;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }

        .message.assistant {
            background: #374151;
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }

        .message.system {
            background: #1f2937;
            margin: 8px auto;
            text-align: center;
            font-size: 13px;
            color: #9ca3af;
            max-width: 90%;
        }

        .message.error {
            background: #7f1d1d;
            border: 1px solid #dc2626;
        }

        .message .actions {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255,255,255,0.1);
            font-size: 13px;
        }

        .message .action-item {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 4px;
            color: #9ca3af;
        }

        .message .action-item::before {
            content: '\2713';
            color: #4ade80;
        }

        .chat-input-bar {
            padding: 12px 16px;
            display: flex;
            gap: 10px;
            border-top: 1px solid #333;
            background: #16213e;
        }

        .chat-input-bar input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #4a5568;
            border-radius: 8px;
            background: #1a1a2e;
            color: #fff;
            font-size: 15px;
        }

        .chat-input-bar input:focus {
            outline: none;
            border-color: #e94560;
        }

        .chat-input-bar button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            background: #e94560;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .chat-input-bar button:hover {
            background: #c73e54;
        }

        .chat-input-bar button:disabled {
            background: #4a5568;
            cursor: not-allowed;
        }

        /* Screenshot Panel */
        .screenshot-panel {
            display: flex;
            flex-direction: column;
            background: #000;
        }

        .screenshot-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: #16213e;
            border-bottom: 1px solid #333;
        }

        .screenshot-header .status {
            font-size: 13px;
            color: #888;
        }

        .screenshot-header .status.online {
            color: #4ade80;
        }

        .screenshot-header .screenshot-btn {
            padding: 6px 12px;
            border: 1px solid #4a5568;
            border-radius: 6px;
            background: #1a1a2e;
            color: #fff;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .screenshot-header .screenshot-btn:hover {
            background: #e94560;
            border-color: #e94560;
        }

        .screenshot-header .screenshot-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .screenshot-header .scroll-btns {
            display: flex;
            gap: 4px;
        }

        .screenshot-header .scroll-btn {
            width: 32px;
            height: 32px;
            border: 1px solid #4a5568;
            border-radius: 6px;
            background: #1a1a2e;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .screenshot-header .scroll-btn:hover {
            background: #e94560;
            border-color: #e94560;
        }

        .screenshot-header .scroll-btn:active {
            transform: scale(0.95);
        }

        .screenshot-view {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
            overflow: hidden;
        }

        .screenshot-view img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 4px;
            cursor: crosshair;
        }

        .screenshot-view img:hover {
            outline: 2px solid #e94560;
        }

        /* Click indicator */
        .click-indicator {
            position: absolute;
            width: 20px;
            height: 20px;
            border: 3px solid #e94560;
            border-radius: 50%;
            pointer-events: none;
            animation: click-pulse 0.5s ease-out forwards;
            transform: translate(-50%, -50%);
        }

        @keyframes click-pulse {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(2);
                opacity: 0;
            }
        }

        .screenshot-view {
            position: relative;
        }

        .click-hint {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: #fff;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
        }

        /* Screenshot update indicator */
        .screenshot-updated {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #4ade80;
            color: #000;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            animation: fade-out 0.8s ease-out forwards;
            pointer-events: none;
        }

        @keyframes fade-out {
            0% { opacity: 1; }
            60% { opacity: 1; }
            100% { opacity: 0; }
        }

        .screenshot-view .placeholder {
            color: #666;
            text-align: center;
        }

        /* Loading indicator */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 8px 12px;
            background: #374151;
            border-radius: 12px;
            width: fit-content;
            margin-bottom: 16px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: #9ca3af;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 100% { opacity: 0.3; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- Chat Panel (Left) -->
        <div class="chat-panel">
            <div class="chat-header">
                <button class="nav-btn" id="backBtn" title="ËøîÂõûÊéßÂà∂Âè∞">&larr;</button>
                <h1>AI Browser Control</h1>
                <button class="nav-btn" id="clearBtn" title="Ê∏ÖÈô§Â∞çË©±">&times;</button>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="message system">
                    ÈÄ£Êé• Agent ÂæåÔºåÁî®Ëá™ÁÑ∂Ë™ûË®ÄÊèèËø∞‰Ω†ÊÉ≥Âü∑Ë°åÁöÑÊìç‰Ωú„ÄÇ
                </div>
            </div>

            <div class="chat-input-bar">
                <input type="text" id="chatInput" placeholder="ÊèèËø∞‰Ω†ÊÉ≥Ë¶ÅÂü∑Ë°åÁöÑÂãï‰Ωú..." autocomplete="off">
                <button id="sendBtn">ÁôºÈÄÅ</button>
            </div>
        </div>

        <!-- Screenshot Panel (Right) -->
        <div class="screenshot-panel">
            <div class="screenshot-header">
                <span>ÈÅ†Á´ØÁÄèË¶ΩÂô®</span>
                <div class="scroll-btns">
                    <button class="scroll-btn" id="scrollUpBtn" title="Âêë‰∏äÊªæÂãï">‚Üë</button>
                    <button class="scroll-btn" id="scrollDownBtn" title="Âêë‰∏ãÊªæÂãï">‚Üì</button>
                </div>
                <button class="screenshot-btn" id="screenshotBtn" title="Êì∑ÂèñÊà™Âúñ">üì∑ Êà™Âúñ</button>
                <span class="status" id="connectionStatus">ÈÄ£Á∑ö‰∏≠...</span>
            </div>

            <div class="screenshot-view" id="screenshotView">
                <div class="placeholder">Á≠âÂæÖÊà™Âúñ...</div>
            </div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script>
        const params = new URLSearchParams(window.location.search);
        const agentToken = params.get('agent');

        if (!agentToken) {
            window.location.href = pageUrl('/dashboard.html');
        }

        let ws;
        let isProcessing = false;

        // Check auth first
        fetch(apiUrl('/api/check-auth'))
            .then(r => r.json())
            .then(data => {
                if (!data.authenticated) {
                    window.location.href = pageUrl('/');
                    return;
                }
                connectWebSocket();
            });

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(protocol + '//' + window.location.host + apiUrl('/ws/user'));

            ws.onopen = () => {
                updateStatus('Â∑≤ÈÄ£Êé•‰º∫ÊúçÂô®', true);
                // Connect to specific agent
                ws.send(JSON.stringify({
                    type: 'connect_agent',
                    data: { agent_token: agentToken }
                }));
            };

            ws.onclose = () => {
                updateStatus('ÈÄ£Á∑ö‰∏≠Êñ∑', false);
                setTimeout(connectWebSocket, 3000);
            };

            ws.onerror = () => {
                updateStatus('ÈÄ£Á∑öÈåØË™§', false);
            };

            ws.onmessage = (e) => {
                const msg = JSON.parse(e.data);
                handleMessage(msg);
            };
        }

        function handleMessage(msg) {
            switch (msg.type) {
                case 'agent_status':
                    if (msg.online) {
                        updateStatus('Agent Âú®Á∑ö', true);
                        // Request initial screenshot
                        requestScreenshot();
                    } else {
                        updateStatus('Agent Èõ¢Á∑ö', false);
                    }
                    break;

                case 'screenshot':
                    renderScreenshot(
                        msg.image || (msg.data && msg.data.image),
                        msg.width || (msg.data && msg.data.width),
                        msg.height || (msg.data && msg.data.height)
                    );
                    break;

                case 'action_result':
                    // Handle direct action result
                    if (msg.success) {
                        addMessage('system', msg.message || 'Êìç‰ΩúÂÆåÊàê');
                    } else {
                        addMessage('system', msg.error || 'Êìç‰ΩúÂ§±Êïó', true);
                    }
                    setProcessing(false);
                    // Request new screenshot after action
                    setTimeout(requestScreenshot, 500);
                    break;

                case 'chat_response':
                    handleChatResponse(msg);
                    break;

                case 'error':
                    addMessage('system', msg.error, true);
                    setProcessing(false);
                    break;
            }
        }

        function scrollToBottom() {
            const messages = document.getElementById('chatMessages');
            // Use requestAnimationFrame for smoother scrolling
            requestAnimationFrame(() => {
                messages.scrollTop = messages.scrollHeight;
            });
        }

        function handleChatResponse(msg) {
            // Remove typing indicator
            removeTypingIndicator();

            // Handle screenshot update
            if (msg.screenshot) {
                renderScreenshot(msg.screenshot);
            }

            // Handle text content
            if (msg.content) {
                addMessage(msg.role, msg.content, msg.is_error);
            }

            // Handle actions - add them to the last assistant message
            if (msg.actions && msg.actions.length > 0) {
                const messages = document.getElementById('chatMessages');
                const lastAssistant = messages.querySelector('.message.assistant:last-of-type');
                if (lastAssistant && !lastAssistant.querySelector('.actions')) {
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'actions';

                    msg.actions.forEach(function(action) {
                        const actionItem = document.createElement('div');
                        actionItem.className = 'action-item';
                        actionItem.textContent = action.description;
                        actionsDiv.appendChild(actionItem);
                    });

                    lastAssistant.appendChild(actionsDiv);
                    scrollToBottom();
                }
            }

            // If it's an assistant message with content, we might still be processing
            // Only stop processing if we received actual text content
            if (msg.role === 'assistant' && msg.content) {
                setProcessing(false);
            }
        }

        function addMessage(role, content, isError) {
            isError = isError || false;
            const messages = document.getElementById('chatMessages');
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message ' + role + (isError ? ' error' : '');
            msgDiv.textContent = content;
            messages.appendChild(msgDiv);
            scrollToBottom();
        }

        function addTypingIndicator() {
            const messages = document.getElementById('chatMessages');
            const existing = messages.querySelector('.typing-indicator');
            if (existing) return;

            const indicator = document.createElement('div');
            indicator.className = 'typing-indicator';

            for (let i = 0; i < 3; i++) {
                const span = document.createElement('span');
                indicator.appendChild(span);
            }

            messages.appendChild(indicator);
            scrollToBottom();
        }

        function removeTypingIndicator() {
            const messages = document.getElementById('chatMessages');
            const indicator = messages.querySelector('.typing-indicator');
            if (indicator) indicator.remove();
        }

        // Store actual screenshot dimensions (default 1920x1080)
        let screenshotWidth = 1920;
        let screenshotHeight = 1080;

        function renderScreenshot(imageData, width, height) {
            if (!imageData) return;

            // Update dimensions if provided
            if (width) screenshotWidth = width;
            if (height) screenshotHeight = height;

            const view = document.getElementById('screenshotView');
            // Clear existing content safely (except hint)
            const existingHint = view.querySelector('.click-hint');
            while (view.firstChild) {
                view.removeChild(view.firstChild);
            }

            const img = document.createElement('img');
            // Handle both raw base64 and data URI formats
            if (imageData.startsWith('data:')) {
                img.src = imageData;
            } else {
                img.src = 'data:image/png;base64,' + imageData;
            }
            img.alt = 'Screenshot';

            // Add click handler for direct clicking
            img.addEventListener('click', handleScreenshotClick);

            view.appendChild(img);

            // Add click hint
            const hint = document.createElement('div');
            hint.className = 'click-hint';
            hint.textContent = 'ÈªûÊìäÊà™ÂúñÁõ¥Êé•Êìç‰Ωú';
            view.appendChild(hint);

            // Show update indicator
            showScreenshotUpdated();
        }

        function showScreenshotUpdated() {
            const view = document.getElementById('screenshotView');

            // Remove existing indicator
            const existing = view.querySelector('.screenshot-updated');
            if (existing) existing.remove();

            // Add new indicator
            const indicator = document.createElement('div');
            indicator.className = 'screenshot-updated';
            indicator.textContent = 'Â∑≤Êõ¥Êñ∞';
            view.appendChild(indicator);

            // Remove after animation (800ms)
            setTimeout(() => {
                if (indicator.parentNode) indicator.remove();
            }, 800);
        }

        function handleScreenshotClick(e) {
            if (isProcessing) {
                addMessage('system', 'Ë´ãÁ≠âÂæÖÁï∂ÂâçÊìç‰ΩúÂÆåÊàê', false);
                return;
            }

            const img = e.target;

            // Use the image's natural dimensions (actual pixel size)
            const naturalWidth = img.naturalWidth || 1920;
            const naturalHeight = img.naturalHeight || 1080;

            // Get the displayed size and position
            const rect = img.getBoundingClientRect();

            // Calculate the actual rendered image size (accounting for object-fit: contain)
            const imgAspect = naturalWidth / naturalHeight;
            const containerAspect = rect.width / rect.height;

            let renderedWidth, renderedHeight, offsetX, offsetY;

            if (imgAspect > containerAspect) {
                // Image is wider than container - fits width, letterbox top/bottom
                renderedWidth = rect.width;
                renderedHeight = rect.width / imgAspect;
                offsetX = 0;
                offsetY = (rect.height - renderedHeight) / 2;
            } else {
                // Image is taller than container - fits height, letterbox left/right
                renderedHeight = rect.height;
                renderedWidth = rect.height * imgAspect;
                offsetX = (rect.width - renderedWidth) / 2;
                offsetY = 0;
            }

            // Calculate click position relative to the actual rendered image
            const relativeX = e.clientX - rect.left - offsetX;
            const relativeY = e.clientY - rect.top - offsetY;

            // Check if click is within the actual image area
            if (relativeX < 0 || relativeX > renderedWidth || relativeY < 0 || relativeY > renderedHeight) {
                console.log('Click outside image area');
                return;
            }

            // Convert to actual screenshot coordinates (simple ratio)
            const actualX = Math.round((relativeX / renderedWidth) * naturalWidth);
            const actualY = Math.round((relativeY / renderedHeight) * naturalHeight);

            console.log(`Screenshot: ${naturalWidth}x${naturalHeight}, Rendered: ${renderedWidth.toFixed(0)}x${renderedHeight.toFixed(0)}, Offset: (${offsetX.toFixed(0)}, ${offsetY.toFixed(0)})`);
            console.log(`Click: relative (${relativeX.toFixed(0)}, ${relativeY.toFixed(0)}) -> actual (${actualX}, ${actualY})`);

            // Show click indicator
            showClickIndicator(e.clientX, e.clientY);

            // Send direct click action
            sendDirectClick(actualX, actualY);
        }

        function showClickIndicator(x, y) {
            const indicator = document.createElement('div');
            indicator.className = 'click-indicator';
            indicator.style.left = x + 'px';
            indicator.style.top = y + 'px';
            document.body.appendChild(indicator);

            // Remove after animation
            setTimeout(() => indicator.remove(), 500);
        }

        function sendDirectClick(x, y) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addMessage('system', 'Êú™ÈÄ£Êé•Âà∞‰º∫ÊúçÂô®', true);
                return;
            }

            setProcessing(true);
            addMessage('system', `ÈªûÊìäÂ∫ßÊ®ô (${x}, ${y})...`);

            ws.send(JSON.stringify({
                type: 'direct_action',
                data: {
                    action: 'click_xy',
                    x: x,
                    y: y
                }
            }));
        }

        function requestScreenshot() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            ws.send(JSON.stringify({ type: 'request_screenshot' }));
        }

        function sendChatMessage(message) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addMessage('system', 'Êú™ÈÄ£Êé•Âà∞‰º∫ÊúçÂô®', true);
                return;
            }

            if (isProcessing) return;

            // Add user message to UI
            addMessage('user', message);

            // Show typing indicator
            addTypingIndicator();
            setProcessing(true);

            // Send to server
            ws.send(JSON.stringify({
                type: 'chat_message',
                data: { message: message }
            }));
        }

        function clearConversation() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;

            ws.send(JSON.stringify({ type: 'clear_conversation' }));

            // Clear UI safely
            const messages = document.getElementById('chatMessages');
            while (messages.firstChild) {
                messages.removeChild(messages.firstChild);
            }

            const clearedMsg = document.createElement('div');
            clearedMsg.className = 'message system';
            clearedMsg.textContent = 'Â∞çË©±Â∑≤Ê∏ÖÈô§„ÄÇ';
            messages.appendChild(clearedMsg);
        }

        function setProcessing(processing) {
            isProcessing = processing;
            const input = document.getElementById('chatInput');
            const btn = document.getElementById('sendBtn');
            input.disabled = processing;
            btn.disabled = processing;
        }

        function updateStatus(text, connected) {
            const el = document.getElementById('connectionStatus');
            el.textContent = text;
            el.className = 'status ' + (connected ? 'online' : '');
        }

        // Event handlers
        document.getElementById('backBtn').onclick = function() {
            window.location.href = pageUrl('/dashboard.html');
        };

        document.getElementById('clearBtn').onclick = function() {
            if (confirm('Á¢∫ÂÆöË¶ÅÊ∏ÖÈô§Â∞çË©±Ë®òÈåÑÂóéÔºü')) {
                clearConversation();
            }
        };

        document.getElementById('screenshotBtn').onclick = function() {
            requestScreenshot();
        };

        document.getElementById('scrollUpBtn').onclick = function() {
            sendScroll('up');
        };

        document.getElementById('scrollDownBtn').onclick = function() {
            sendScroll('down');
        };

        function sendScroll(direction) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addMessage('system', 'Êú™ÈÄ£Êé•Âà∞‰º∫ÊúçÂô®', true);
                return;
            }

            const agentToken = new URLSearchParams(window.location.search).get('agent');
            if (!agentToken) return;

            ws.send(JSON.stringify({
                type: 'scroll',
                direction: direction,
                amount: 500
            }));

            // Request screenshot after scroll
            setTimeout(requestScreenshot, 300);
        }

        document.getElementById('sendBtn').onclick = function() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (message) {
                sendChatMessage(message);
                input.value = '';
            }
        };

        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                const message = e.target.value.trim();
                if (message) {
                    sendChatMessage(message);
                    e.target.value = '';
                }
            }
        });

        // Auto-focus input
        document.getElementById('chatInput').focus();
    </script>
</body>
</html>
